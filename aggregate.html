<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æ±‡æ€»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }

        /* æŠ˜å ç»„æ ·å¼ */
        .form-group-section {
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .form-group-section:hover {
            border-color: #d1d5db;
        }

        .form-group-section.active {
            border-color: #667eea;
        }

        /* æŠ˜å å¤´éƒ¨ */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
        }

        .section-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }

        .form-group-section.active .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
        }

        .section-icon {
            font-size: 24px;
        }

        .toggle-icon {
            font-size: 24px;
            transition: transform 0.3s ease;
        }

        .form-group-section.active .toggle-icon {
            transform: rotate(180deg);
        }

        /* æŠ˜å å†…å®¹ */
        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
            padding: 0 24px;
        }

        .form-group-section.active .section-content {
            max-height: 2000px;
            padding: 24px;
        }

        /* è¡¨å•é¡¹ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-label .required {
            color: #ef4444;
            margin-left: 4px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        /* å•é€‰æ¡†å’Œå¤é€‰æ¡† */
        .radio-group,
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-item,
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"],
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-item label,
        .checkbox-item label {
            cursor: pointer;
            font-weight: normal;
            margin: 0;
        }

        /* æäº¤æŒ‰é’® */
        .form-actions {
            margin-top: 30px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* å¸®åŠ©æ–‡æœ¬ */
        .form-help {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        /* å±•å¼€/æ”¶èµ·æ‰€æœ‰æŒ‰é’® */
        .collapse-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            justify-content: flex-end;
        }

        .collapse-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .collapse-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        #alert {
            height: 100px;
        }
    </style>
</head>

<body>
    <div class="form-container">
        <!-- åœ¨containerå†…æ·»åŠ loadingé®ç½© -->
        <div id="loadingMask" style="display: none;">
            <div class="loading-content">
                <div class="spinner"></div>
                <p>æ­£åœ¨æäº¤æ•°æ®...</p>
            </div>
        </div>
        <h1>ğŸ“‹ æ•°æ®æ±‡æ€»</h1>

        <div class="collapse-controls">
            <button type="button" class="collapse-btn" onclick="expandAll()">ğŸ“‚ å±•å¼€å…¨éƒ¨</button>
            <button type="button" class="collapse-btn" onclick="collapseAll()">ğŸ“ æ”¶èµ·å…¨éƒ¨</button>
        </div>

        <form id="mainForm">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="form-group-section active">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">ğŸ” </span>
                        <span>è€ƒè¯•æˆç»©æ€»è¡¨</span>
                    </div>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                å›¢é˜ŸAPP TOKEN<span class="required">*</span>
                            </label>
                            <input type="text" id="app_token" name="app_token" class="form-input"
                                placeholder="è¯·è¾“å…¥APP TOKEN" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                å›¢é˜ŸPERSON TOKEN<span class="required">*</span>
                            </label>
                            <input type="text" id="person_token" name="person_token" class="form-input"
                                placeholder="è¯·è¾“å…¥PERSON TOKEN" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                TABLE ID<span class="required">*</span>
                            </label>
                            <input type="text" id="exam_table_id" name="exam_table_id" class="form-input"
                                placeholder="è€ƒè¯•æˆç»©æ€»è¡¨ID" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è”ç³»æ–¹å¼ -->
            <div class="form-group-section">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">ğŸ›—</span>
                        <span>å‚ä¼šè¯¦æƒ…æ€»è¡¨</span>
                    </div>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div class="section-content">
                    <!-- <div class="form-group">
                        <label class="form-label">
                            æ‰‹æœºå·ç <span class="required">*</span>
                        </label>
                        <input type="tel" name="phone" class="form-input" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " required>
                        <div class="form-help">è¯·è¾“å…¥11ä½æ‰‹æœºå·ç </div>
                    </div> -->

                    <div class="form-group">
                        <label class="form-label">
                            TABLE ID<span class="required">*</span>
                        </label>
                        <input type="text" id="meeting_table_id" name="meeting_table_id" class="form-input"
                            placeholder="è¯·è¾“å…¥å‚ä¼šè¯¦æƒ…æ€»è¡¨ID" required>
                    </div>
                </div>
            </div>

            <!-- æ•™è‚²èƒŒæ™¯ -->
            <div class="form-group-section">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">ğŸ…°ï¸</span>
                        <span>è€ƒè¯•è¯¦æƒ…è¡¨</span>
                    </div>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label class="form-label">
                            TABLE ID<span class="required">*</span>
                        </label>
                        <input type="text" id="exam_detail_table_id" name="exam_detail_table_id" class="form-input"
                            placeholder="è¯·è¾“å…¥è€ƒè¯•è¯¦æƒ…è¡¨ID" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            VIEW ID<span class="required">*</span>
                        </label>
                        <input type="text" id="exam_detail_view_id" name="exam_detail_view_id" class="form-input"
                            placeholder="è¯·è¾“å…¥è€ƒè¯•è¯¦æƒ…è§†å›¾ID" required>
                    </div>
                </div>
                <!-- <div class="section-content">
                    <div class="form-group">
                        <label class="form-label">
                            åœºæ¬¡<span class="required">*</span>
                        </label>
                        <input type="text" id="exam_detail_session" name="exam_detail_session" class="form-input"
                            placeholder="è¯·è¾“å…¥è€ƒè¯•åœºæ¬¡" required>
                    </div>
                </div> -->
            </div>

            <!-- å·¥ä½œä¿¡æ¯ -->
            <div class="form-group-section">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">ğŸš¹</span>
                        <span>å‚ä¼šäººå‘˜è¯¦æƒ…</span>
                    </div>
                    <span class="toggle-icon">â–¼</span>
                </div>
                <div class="section-content">

                    <div class="form-group">
                        <label class="form-label">
                            ä¸ªäººAPP TOKEN<span class="required">*</span>
                        </label>
                        <input type="text" id="private_app_token" name="private_app_token" class="form-input"
                            placeholder="è¯·è¾“å…¥APP TOKEN" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            ä¸ªäººPERSON TOKEN<span class="required">*</span>
                        </label>
                        <input type="text" id="private_person_token" name="private_person_token" class="form-input"
                            placeholder="è¯·è¾“å…¥PERSON TOKEN" required>
                    </div>



                    <div class="form-group">
                        <label class="form-label">
                            TABLE ID<span class="required">*</span>
                        </label>
                        <input type="text" id="meeting_detail_table_id" name="meeting_detail_table_id"
                            class="form-input" placeholder="è¯·è¾“å…¥å‚ä¼šäººå‘˜è¯¦æƒ…ID" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            VIEW ID<span class="required">*</span>
                        </label>
                        <input type="text" id="meeting_detail_view_id" name="meeting_detail_view_id" class="form-input"
                            placeholder="è¯·è¾“å…¥å‚ä¼šäººå‘˜è§†å›¾ID" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            ä¼šè®®å¼€å§‹æ—¶é—´<span class="required">*</span>
                        </label>
                        <input type="datetime-local" id="meeting_detail_start" name="meeting_detail_start"
                            class="form-input" placeholder="è¯·è¾“å…¥TABLE ID" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            ä¼šè®®ç»“æŸæ—¶é—´<span class="required">*</span>
                        </label>
                        <input type="datetime-local" id="meeting_detail_end" name="meeting_detail_end"
                            class="form-input" placeholder="è¯·è¾“å…¥PERSON TOKEN" required>
                    </div>

                </div>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <div class="form-actions">
                <button type="submit" id="examSubmitBtn" class="btn btn-primary">âœ“ æ±‡æ€»è€ƒè¯•</button>
                <button type="submit" id="meetingSubmitBtn" class="btn btn-primary">âœ“ æ±‡æ€»å‚ä¼š</button>
                <button type="reset" id="resetBtn" class="btn btn-secondary">â†» é‡ç½®</button>
            </div>
            <div id="alert" class="alert"></div>
        </form>
    </div>


    <script type="module">
        import DBStorage from './assets/dbStorage.js';
        const dbStorage = new DBStorage('feishu', 'config');
        const BATCH_SIZE = 400;
        var config = {};
        var moduelName = 'aggregate';
        var keys = [
            'app_token',
            'person_token',
            'exam_table_id',
            'meeting_table_id',
            // 'exam_detail_table_id',
            // 'exam_detail_view_id',
            'private_app_token',
            'private_person_token',
            // 'meeting_detail_table_id',
            // 'meeting_detail_start',
            // 'meeting_detail_end',
            // 'exam_detail_session',
        ];
        keys.forEach(key => {
            dbStorage.getItem(`${moduelName}_${key}`).then(value => {
                if (value) {
                    document.getElementById(key).value = value;
                }
            });
        });


        // åˆ‡æ¢æŠ˜å ç»„
        function toggleSection(header) {
            const section = header.parentElement;
            section.classList.toggle('active');
        }

        // å±•å¼€æ‰€æœ‰
        function expandAll() {
            const sections = document.querySelectorAll('.form-group-section');
            sections.forEach(section => {
                section.classList.add('active');
            });
        }

        // æ”¶èµ·æ‰€æœ‰
        function collapseAll() {
            const sections = document.querySelectorAll('.form-group-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
        }
        // é¡µé¢åŠ è½½æ—¶é»˜è®¤å±•å¼€ç¬¬ä¸€ä¸ªåˆ†ç»„
        document.addEventListener('DOMContentLoaded', function () {
            const firstSection = document.querySelector('.form-group-section');
            if (firstSection) {
                firstSection.classList.add('active');
            }
        });

        document.querySelectorAll('.section-header').forEach(header => {
            header.addEventListener('click', function () {
                toggleSection(this);
            });
        });
        let excelData = null;
        let formObject = {};
        let uploadedFileName = '';
        const isEmpty = (obj) =>
            Object.prototype.toString.call(obj) === '[object Object]'
            && Reflect.ownKeys(obj).length === 0;

        async function getRecords(data, app_token, tableId, person_token) {
            const url = `https://base-api.feishu.cn/open-apis/bitable/v1/apps/${app_token}/tables/${tableId}/records/search`;
            console.log('Fetching records from:', url);
            let allItems = [];
            let pageToken = undefined; // åˆå§‹æ—  page_token
            let hasMore = true;
            try {
                do {
                    // æ„é€ æœ¬æ¬¡è¯·æ±‚çš„ body
                    const requestData = { ...data }; // é¿å…ä¿®æ”¹åŸå§‹ data

                    // è®¾ç½®åˆç†çš„ page_sizeï¼ˆæœ€å¤§ 500ï¼Œé£ä¹¦é™åˆ¶ï¼‰
                    requestData.page_size = BATCH_SIZE;

                    if (pageToken) {
                        requestData.page_token = pageToken;
                    }
                    console.log(requestData)
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            "Content-Type": "application/json; charset=utf-8",
                            "Authorization": `Bearer ${person_token}`
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();

                    // æ£€æŸ¥é£ä¹¦ API è¿”å›ç 
                    if (result.code !== 0) {
                        throw new Error(`é£ä¹¦ API é”™è¯¯: ${result.msg} (code: ${result.code})`);
                    }

                    const pageData = result.data;
                    if (pageData && Array.isArray(pageData.items)) {
                        allItems = allItems.concat(pageData.items);
                    }

                    // æ›´æ–° page_token å’Œ has_more
                    pageToken = pageData.page_token;
                    hasMore = pageData.has_more;

                    console.log(`å·²è·å– ${allItems.length} æ¡è®°å½•, has_more: ${hasMore}`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                } while (hasMore); // å½“æœ‰ page_token æ—¶ç»§ç»­ï¼ˆé£ä¹¦æ–‡æ¡£ï¼šhas_more ä¸º true æ—¶æ‰æœ‰ page_tokenï¼‰

                showAlert(`æˆåŠŸè·å–å…¨éƒ¨ ${allItems.length} æ¡è®°å½•`, 'success');
                return allItems;

            } catch (error) {
                console.error('è·å–è®°å½•å¤±è´¥:', error);
                document.getElementById('loadingMask').style.display = 'none';
                showAlert(`è·å–æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                return null;
            }
        }

        async function createRecords(records, app_token, table_id, person_token) {

            // æ˜¾ç¤º loadingï¼ˆå»ºè®®åœ¨å¤–å±‚æ˜¾ç¤ºï¼Œä½†å¦‚æœä½ åšæŒåœ¨è¿™é‡Œæ§åˆ¶ï¼‰
            // document.getElementById('loadingMask').style.display = 'block';

            try {
                // å¦‚æœ records ä¸æ˜¯æ•°ç»„æˆ–ä¸ºç©ºï¼Œç›´æ¥è¿”å›
                if (!Array.isArray(records) || records.length === 0) {
                    showAlert('æ— æ•°æ®éœ€è¦æäº¤', 'warning');
                    return null;
                }

                const total = records.length;
                let successCount = 0;

                // åˆ†æ‰¹å‘é€
                for (let i = 0; i < total; i += BATCH_SIZE) {
                    const batch = records.slice(i, i + BATCH_SIZE);
                    const data = { records: batch };

                    const url = `https://base-api.feishu.cn/open-apis/bitable/v1/apps/${app_token}/tables/${table_id}/records/batch_create?user_id_type=open_id`;

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            "Content-Type": "application/json; charset=utf-8",
                            "Authorization": `Bearer ${person_token}`
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    // æ£€æŸ¥ HTTP çŠ¶æ€
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    // æ£€æŸ¥é£ä¹¦ API è¿”å›ç 
                    if (result.code !== 0) {
                        throw new Error(`${result.msg} (code: ${result.code})`);
                    }

                    successCount += batch.length;
                    console.log(`âœ… å·²æˆåŠŸæäº¤ ${successCount} / ${total} æ¡è®°å½•`);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // å…¨éƒ¨æˆåŠŸ
                document.getElementById('loadingMask').style.display = 'none';
                showAlert(`æ•°æ®æäº¤æˆåŠŸï¼å…± ${successCount} æ¡`, 'success');
                return { success: true, count: successCount };

            } catch (error) {
                document.getElementById('loadingMask').style.display = 'none';
                console.error('æ‰¹é‡åˆ›å»ºè®°å½•å¤±è´¥:', error);
                showAlert(`æäº¤å¤±è´¥: ${error.message}`, 'error');
                return null;
            }
        }

        async function getExamDetailRecords() {
            let data = {
                "automatic_fields": false,
                "field_names": [
                    "è€ƒè¯•äºº",
                    "æ€»åˆ†",
                    "æ˜¯å¦åŠæ ¼",
                ],
                // "filter": {
                //     "conditions": [
                //         {
                //             "field_name": "åˆ†ç±»",
                //             "operator": "is",
                //             "value": [
                //                 "äº¤é€šè´¹"
                //             ]
                //         }
                //     ],
                //     "conjunction": "and"
                // },
                "view_id": formObject.exam_detail_view_id
            }
            return await getRecords(data, formObject.app_token, formObject.exam_detail_table_id, formObject.person_token);
        }
        async function copyToExamTotal() {
            let res = await getExamDetailRecords();
            console.log(res);
            // var records = [
            // {
            //     "fields": {
            //         "äººå‘˜": [{ "id": "451gbbad" }]
            //     }
            // }
            // ];
            var records = [];
            res.forEach((row, index) => {
                if (isEmpty(row.fields)) return; // è·³è¿‡ç©ºè¡Œ
                var record = {
                    "fields": {
                        "è€ƒè¯•äºº": [{ "id": row.fields['è€ƒè¯•äºº'][0].id }],
                        "æ€»åˆ†": row.fields['æ€»åˆ†'].value[0],
                        "æ˜¯å¦åŠæ ¼": row.fields['æ˜¯å¦åŠæ ¼'].value[0].text,
                        // "åœºæ¬¡": formObject.exam_detail_session,
                    }
                };
                records.push(record);
            });



            await createRecords(records, formObject.app_token, formObject.exam_table_id, formObject.person_token);

        }
        async function getUserDetailRecords() {
            let data = {
                "automatic_fields": false,
                "field_names": [
                    "å‚ä¼šäºº",
                    "é¦–æ¬¡å…¥ä¼šæ—¶é—´",
                    "æœ€åç¦»ä¼šæ—¶é—´",
                ],
                // "filter": {
                //     "conditions": [
                //         {
                //             "field_name": "åˆ†ç±»",
                //             "operator": "is",
                //             "value": [
                //                 "äº¤é€šè´¹"
                //             ]
                //         }
                //     ],
                //     "conjunction": "and"
                // },
                "view_id": formObject.meeting_detail_view_id
            }
            return await getRecords(data, formObject.private_app_token, formObject.meeting_detail_table_id, formObject.private_person_token);
        }

        async function copyToUserTotal() {
            let res = await getUserDetailRecords();
            console.log(res);
            // var records = [
            // {
            //     "fields": {
            //         "äººå‘˜": [{ "id": "451gbbad" }]
            //     }
            // }
            // ];
            var records = [];

            var start = new Date(formObject.meeting_detail_start).getTime();
            var end = new Date(formObject.meeting_detail_end).getTime();
            var diffMs = end - start; // 35åˆ†20ç§’ = 35Ã—60000 + 20Ã—1000 = 2120000 æ¯«ç§’
            var diffMsReal = Math.round(diffMs / 60000);

            res.forEach((row, index) => {
                if (isEmpty(row.fields)) return; // è·³è¿‡ç©ºè¡Œ
                var record = {
                    "fields": {
                        "äººå‘˜": [{ "id": row.fields['å‚ä¼šäºº'][0].id }],
                        "å‚ä¼šæ—¶é—´": row.fields['é¦–æ¬¡å…¥ä¼šæ—¶é—´'] < start ? start : row.fields['é¦–æ¬¡å…¥ä¼šæ—¶é—´'],
                        "æœ€åç¦»ä¼šæ—¶é—´": row.fields['æœ€åç¦»ä¼šæ—¶é—´'] > end ? end : row.fields['æœ€åç¦»ä¼šæ—¶é—´'],
                        "ä¼šè®®æ—¶é•¿": diffMsReal
                    }
                };
                records.push(record);
            });

            await createRecords(records,formObject.app_token,formObject.meeting_table_id,formObject.person_token);
            
        }

        document.getElementById('examSubmitBtn').addEventListener('click', submitData);
        document.getElementById('meetingSubmitBtn').addEventListener('click', submitData);
        // æäº¤æ•°æ®
        async function submitData(e) {
            e.preventDefault();
            const form = document.getElementById('mainForm');

            // éªŒè¯è¡¨å•
            if (!form.checkValidity()) {
                showAlert('è¯·å¡«å†™å¿…å¡«é¡¹ï¼', 'error');
                form.reportValidity();
                return;
            }
            // æ˜¾ç¤ºloading
            document.getElementById('loadingMask').style.display = 'flex';

            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = new FormData(form);
            formObject = {};
            formData.forEach((value, key) => {
                formObject[key] = value;
                dbStorage.setItem(`${moduelName}_${key}`, value);
            });
            if(e.target.id==='examSubmitBtn'){
                await copyToExamTotal();
                console.log("è€ƒè¯•æˆç»©æ±‡æ€»å®Œæˆï¼");
            }
            if(e.target.id==='meetingSubmitBtn'){
                await copyToUserTotal();
                console.log("äººå‘˜å‚ä¼šæ±‡æ€»å®Œæˆï¼");
            }
            document.getElementById('loadingMask').style.display = 'none'; // éšè—loading
            showAlert('æ•°æ®æ±‡æ€»æˆåŠŸï¼', 'success');
        }

        document.getElementById('resetBtn').addEventListener('click', resetAll);
        // é‡ç½®æ‰€æœ‰
        function resetAll() {
            document.getElementById('mainForm').reset();
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('previewTable').style.display = 'none';
            document.getElementById('alert').style.display = 'none';
            excelData = null;
            uploadedFileName = '';
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            console.log('showAlert', message, type);
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 25000);
            // if (type === 'error'){
            //     throw new Error(message);
            // }

        }


        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

    </script>
</body>

</html>