<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB å¯¼å…¥å¯¼å‡ºå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .section h2 {
            color: #555;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .file-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .file-upload-area.drag-over {
            border-color: #667eea;
            background: #e0e7ff;
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .stats-box {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .stats-item:last-child {
            border-bottom: none;
        }

        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .message.show {
            display: block;
        }

        .checkbox-group {
            margin: 15px 0;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ IndexedDB å¯¼å…¥å¯¼å‡ºå·¥å…·</h1>

        <!-- æ•°æ®åº“é…ç½® -->
        <div class="section">
            <h2>æ•°æ®åº“é…ç½®</h2>
            <div class="form-group">
                <label for="dbName">æ•°æ®åº“åç§°</label>
                <input type="text" id="dbName" value="feishu" placeholder="è¾“å…¥æ•°æ®åº“åç§°">
            </div>
            <div class="form-group">
                <label for="dbVersion">æ•°æ®åº“ç‰ˆæœ¬</label>
                <input type="number" id="dbVersion" value="1" min="1">
            </div>
            <button class="btn btn-primary" onclick="initDB()">
                <span>ğŸ”Œ</span> è¿æ¥æ•°æ®åº“
            </button>
            <button class="btn btn-success" onclick="showStats()">
                <span>ğŸ“Š</span> æŸ¥çœ‹ç»Ÿè®¡
            </button>
            <div id="statsContainer"></div>
        </div>

        <!-- å¯¼å‡ºæ•°æ® -->
        <div class="section">
            <h2>å¯¼å‡ºæ•°æ®</h2>
            <button class="btn btn-primary" onclick="exportDB()">
                <span>ğŸ“¥</span> å¯¼å‡ºæ•°æ®åº“
            </button>
            <div id="exportMessage" class="message"></div>
        </div>

        <!-- å¯¼å…¥æ•°æ® -->
        <div class="section">
            <h2>å¯¼å…¥æ•°æ®</h2>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="clearExisting" checked>
                    å¯¼å…¥å‰æ¸…ç©ºç°æœ‰æ•°æ®
                </label>
                <label>
                    <input type="checkbox" id="mergeData">
                    åˆå¹¶æ¨¡å¼ï¼ˆä¿ç•™ç°æœ‰æ•°æ®ï¼‰
                </label>
            </div>
            <div class="file-upload-area" id="fileUploadArea">
                <input type="file" id="fileInput" class="file-input" accept=".json">
                <p style="margin: 10px 0; color: #667eea; font-size: 40px;">ğŸ“</p>
                <p style="font-weight: 600; color: #333;">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                <p style="font-size: 13px; color: #9ca3af; margin-top: 8px;">æ”¯æŒ .json æ ¼å¼</p>
                <p id="selectedFileName" style="margin-top: 15px; color: #059669; font-weight: 500;"></p>
            </div>
            <button class="btn btn-success" onclick="importDB()" style="margin-top: 15px;">
                <span>ğŸ“¤</span> å¯¼å…¥æ•°æ®åº“
            </button>
            <div id="importMessage" class="message"></div>
        </div>

        <!-- å±é™©æ“ä½œ -->
        <div class="section">
            <h2>âš ï¸ å±é™©æ“ä½œ</h2>
            <button class="btn btn-danger" onclick="clearDB()">
                <span>ğŸ—‘ï¸</span> æ¸…ç©ºæ•°æ®åº“
            </button>
            <button class="btn btn-danger" onclick="deleteDB()">
                <span>ğŸ’£</span> åˆ é™¤æ•°æ®åº“
            </button>
        </div>
    </div>

    <script src="./assets/indexeddb-manager.js"></script>
    <script>
        let dbManager = null;

        // åˆå§‹åŒ–æ•°æ®åº“
        async function initDB() {
            const dbName = document.getElementById('dbName').value;
            const dbVersion = parseInt(document.getElementById('dbVersion').value);

            try {
                dbManager = new IndexedDBManager(dbName, dbVersion);
                await dbManager.openDB();
                showMessage('exportMessage', 'æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
            } catch (error) {
                showMessage('exportMessage', 'è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¯¼å‡ºæ•°æ®åº“
        async function exportDB() {
            if (!dbManager) {
                showMessage('exportMessage', 'è¯·å…ˆè¿æ¥æ•°æ®åº“', 'error');
                return;
            }

            try {
                const filename = `${dbManager.dbName}_backup_${new Date().toISOString().slice(0, 10)}.json`;
                await dbManager.exportToFile(filename);
                showMessage('exportMessage', 'å¯¼å‡ºæˆåŠŸï¼', 'success');
            } catch (error) {
                showMessage('exportMessage', 'å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¯¼å…¥æ•°æ®åº“
        async function importDB() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                showMessage('importMessage', 'è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶', 'error');
                return;
            }

            if (!dbManager) {
                await initDB();
            }

            try {
                const clearExisting = document.getElementById('clearExisting').checked;
                const merge = document.getElementById('mergeData').checked;

                await dbManager.importFromFile(file, { clearExisting, merge });
                showMessage('importMessage', 'å¯¼å…¥æˆåŠŸï¼', 'success');
                
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                fileInput.value = '';
                document.getElementById('selectedFileName').textContent = '';
            } catch (error) {
                showMessage('importMessage', 'å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        async function showStats() {
            if (!dbManager) {
                showMessage('exportMessage', 'è¯·å…ˆè¿æ¥æ•°æ®åº“', 'error');
                return;
            }

            try {
                const stats = await dbManager.getStats();
                const container = document.getElementById('statsContainer');
                
                let html = '<div class="stats-box">';
                html += `<div class="stats-item"><strong>æ•°æ®åº“åç§°:</strong> <span>${stats.dbName}</span></div>`;
                html += `<div class="stats-item"><strong>ç‰ˆæœ¬:</strong> <span>${stats.version}</span></div>`;
                
                stats.stores.forEach(store => {
                    html += `<div class="stats-item"><strong>${store.name}:</strong> <span>${store.count} æ¡è®°å½•</span></div>`;
                });
                
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                showMessage('exportMessage', 'è·å–ç»Ÿè®¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸…ç©ºæ•°æ®åº“
        async function clearDB() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            if (!dbManager) {
                showMessage('exportMessage', 'è¯·å…ˆè¿æ¥æ•°æ®åº“', 'error');
                return;
            }

            try {
                const data = await dbManager.exportDatabase();
                for (const storeName of Object.keys(data.stores)) {
                    await dbManager.importStore(storeName, { data: [], indexes: [], keyPath: null, autoIncrement: false }, false);
                }
                showMessage('exportMessage', 'æ•°æ®å·²æ¸…ç©º', 'success');
            } catch (error) {
                showMessage('exportMessage', 'æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ é™¤æ•°æ®åº“
        async function deleteDB() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ•´ä¸ªæ•°æ®åº“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            if (!dbManager) {
                showMessage('exportMessage', 'è¯·å…ˆè¿æ¥æ•°æ®åº“', 'error');
                return;
            }

            try {
                dbManager.close();
                await dbManager.deleteDatabase();
                dbManager = null;
                showMessage('exportMessage', 'æ•°æ®åº“å·²åˆ é™¤', 'success');
            } catch (error) {
                showMessage('exportMessage', 'åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `message ${type} show`;
            setTimeout(() => {
                element.classList.remove('show');
            }, 5000);
        }

        // æ–‡ä»¶æ‹–æ‹½å¤„ç†
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');

        fileUploadArea.addEventListener('click', () => fileInput.click());

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, () => {
                fileUploadArea.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, () => {
                fileUploadArea.classList.remove('drag-over');
            });
        });

        fileUploadArea.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                updateFileName(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                updateFileName(e.target.files[0]);
            }
        });

        function updateFileName(file) {
            document.getElementById('selectedFileName').textContent = `å·²é€‰æ‹©: ${file.name}`;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
        window.addEventListener('load', () => {
            initDB();
        });
    </script>
</body>
</html>